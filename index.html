<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Simple Call</title>
<style>
body {
  font-family: sans-serif;
  text-align: center;
  margin-top: 20vh;
}
button {
  font-size: 36px;
  padding: 30px 60px;
  margin: 20px;
}
.hidden {
  display: none;
}
</style>
</head>
<body>

<!-- ===== å½¹å‰²é¸æŠ ===== -->
<div id="select">
  <h1>å½¹å‰²ã‚’é¸æŠ</h1>
  <button id="btnCaller">é³´ã‚‰ã™å´</button><br>
  <button id="btnListener">é³´ã‚‰ã•ã‚Œã‚‹å´</button>
</div>

<!-- ===== é³´ã‚‰ã™å´ ===== -->
<div id="caller" class="hidden">
  <h1>å‘¼ã³å‡ºã—</h1>
  <button id="callBtn">å‘¼ã¶</button>
</div>

<!-- ===== é³´ã‚‰ã•ã‚Œã‚‹å´ ===== -->
<div id="listener" class="hidden">
  <h1 id="status">å¾…æ©Ÿä¸­ï¼ˆéŸ³å£°ONã—ã¦ãã ã•ã„ï¼‰</h1>
  <button id="audioBtn">éŸ³å£°ON</button>
</div>

<audio id="sound" src="sound.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, onSnapshot,
  updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== Firebaseè¨­å®š ===== */
const app = initializeApp({
  apiKey: "XXXX",
  authDomain: "XXXX.firebaseapp.com",
  projectId: "XXXX"
});
const db = getFirestore(app);
const ref = doc(db, "calls", "main");

/* ===== DOM ===== */
const select = document.getElementById("select");
const caller = document.getElementById("caller");
const listener = document.getElementById("listener");

const btnCaller = document.getElementById("btnCaller");
const btnListener = document.getElementById("btnListener");

const callBtn = document.getElementById("callBtn");
const audioBtn = document.getElementById("audioBtn");
const status = document.getElementById("status");
const audio = document.getElementById("sound");

/* ===== é³´ã‚‰ã™å´ ===== */
btnCaller.onclick = () => {
  select.classList.add("hidden");
  caller.classList.remove("hidden");
};

callBtn.onclick = async () => {
  await setDoc(ref, {
    ring: true,
    updatedAt: serverTimestamp()
  });
};

/* ===== é³´ã‚‰ã•ã‚Œã‚‹å´ ===== */
btnListener.onclick = () => {
  select.classList.add("hidden");
  listener.classList.remove("hidden");

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
  onSnapshot(ref, async (snap) => {
    if (snap.exists() && snap.data().ring) {
      audio.currentTime = 0;
      audio.play();
      status.textContent = "ğŸ”” å‘¼ã³å‡ºã—ä¸­";
      await updateDoc(ref, { ring: false });
    }
  });
};

// åˆå›éŸ³å£°æœ‰åŠ¹åŒ–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å¯¾ç­–ï¼‰
audioBtn.onclick = () => {
  audio.play().then(() => {
    audio.pause();
    status.textContent = "å¾…æ©Ÿä¸­";
    audioBtn.style.display = "none";
  });
};
</script>

</body>
</html>
