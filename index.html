<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NSCall</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    text-align: center;
    background: #f5f5f5;
    margin: 0;
    padding-top: 20vh;
  }
  h1 {
    font-size: 32px;
    margin-bottom: 20px;
  }
  button {
    font-size: 32px;
    padding: 24px 48px;
    margin: 16px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
  }
  .hidden {
    display: none;
  }
  .caller button {
    background: #e53935;
    color: #fff;
  }
  .listener button {
    background: #1e88e5;
    color: #fff;
  }
</style>
</head>
<body>

<!-- ===== å½¹å‰²é¸æŠ ===== -->
<div id="select">
  <h1>å½¹å‰²ã‚’é¸æŠ</h1>
  <button id="selectCaller">é³´ã‚‰ã™å´</button><br>
  <button id="selectListener">é³´ã‚‰ã•ã‚Œã‚‹å´</button>
</div>

<!-- ===== é³´ã‚‰ã™å´ ===== -->
<div id="caller" class="hidden caller">
  <h1>å‘¼ã³å‡ºã—</h1>
  <button id="callBtn">å‘¼ã¶</button>
</div>

<!-- ===== é³´ã‚‰ã•ã‚Œã‚‹å´ ===== -->
<div id="listener" class="hidden listener">
  <h1 id="status">å¾…æ©Ÿä¸­ï¼ˆéŸ³å£°ONã—ã¦ãã ã•ã„ï¼‰</h1>
  <button id="enableAudio">éŸ³å£°ON</button>
</div>

<audio id="sound" src="sound.mp3" preload="auto"></audio>

<script type="module">
/* ===============================
   Firebase SDKï¼ˆCDNï¼‰
================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  onSnapshot,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===============================
   Firebase è¨­å®šï¼ˆã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyA-0pjEemq37VlZHd22Wh6iCELwanieQMg",
  authDomain: "nscall-35754.firebaseapp.com",
  projectId: "nscall-35754"
};

/* ===============================
   åˆæœŸåŒ–
================================ */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const callRef = doc(db, "calls", "main");

/* ===============================
   DOM
================================ */
const select = document.getElementById("select");
const caller = document.getElementById("caller");
const listener = document.getElementById("listener");

const selectCaller = document.getElementById("selectCaller");
const selectListener = document.getElementById("selectListener");

const callBtn = document.getElementById("callBtn");
const enableAudio = document.getElementById("enableAudio");
const status = document.getElementById("status");
const sound = document.getElementById("sound");

/* ===============================
   é³´ã‚‰ã™å´
================================ */
selectCaller.onclick = () => {
  select.classList.add("hidden");
  caller.classList.remove("hidden");
};

callBtn.onclick = async () => {
  await setDoc(callRef, {
    ring: true,
    updatedAt: serverTimestamp()
  });
};

/* ===============================
   é³´ã‚‰ã•ã‚Œã‚‹å´
================================ */
selectListener.onclick = () => {
  select.classList.add("hidden");
  listener.classList.remove("hidden");

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
  onSnapshot(callRef, async (snap) => {
    if (snap.exists() && snap.data().ring === true) {
      sound.currentTime = 0;
      await sound.play();
      status.textContent = "ğŸ”” å‘¼ã³å‡ºã—ä¸­";
      await updateDoc(callRef, { ring: false });
    }
  });
};

// åˆå›éŸ³å£°æœ‰åŠ¹åŒ–ï¼ˆiOS / Chrome å¯¾ç­–ï¼‰
enableAudio.onclick = async () => {
  await sound.play();
  sound.pause();
  sound.currentTime = 0;
  enableAudio.style.display = "none";
  status.textContent = "å¾…æ©Ÿä¸­";
};
</script>

</body>
</html>
