<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NSCall DEBUG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    background: #000;
    color: #0f0;
    font-family: monospace;
    padding: 20px;
  }
  button {
    font-size: 24px;
    padding: 20px 40px;
    margin: 10px 0;
  }
  .ok { color: #0f0; }
  .ng { color: #f00; }
</style>
</head>
<body>

<h2>NSCall DEBUG</h2>

<button id="btnListen">â‘  é³´ã‚‰ã•ã‚Œã‚‹å´</button>
<button id="btnCall">â‘¡ å‘¼ã¶</button>

<div id="log"></div>

<audio id="audio" src="audio.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, onSnapshot, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const log = msg => {
  document.getElementById("log").innerHTML += msg + "<br>";
};

log("â–¶ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†");

const firebaseConfig = {
  apiKey: "AIzaSyA-0pjEemq37VlZHd22Wh6iCELwanieQMg",
  authDomain: "nscall-35754.firebaseapp.com",
  projectId: "nscall-35754"
};

const app = initializeApp(firebaseConfig);
log("âœ” Firebase initializeApp OK");

const db = getFirestore(app);
const ref = doc(db, "calls", "main");

const audio = document.getElementById("audio");

// éŸ³å£°ãƒ­ãƒ¼ãƒ‰ç¢ºèª
audio.onloadeddata = () => log("âœ” audio.mp3 èª­ã¿è¾¼ã¿æˆåŠŸ");
audio.onerror = () => log("âŒ audio.mp3 èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆãƒ‘ã‚¹é•ã„ï¼‰");

// é³´ã‚‰ã•ã‚Œã‚‹å´
btnListen.onclick = async () => {
  log("â–¶ é³´ã‚‰ã•ã‚Œã‚‹å´ é–‹å§‹");

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§éŸ³å£°è§£æ”¾
  try {
    await audio.play();
    audio.pause();
    audio.currentTime = 0;
    log("âœ” éŸ³å£°å†ç”Ÿè¨±å¯ OK");
  } catch {
    log("âŒ éŸ³å£°å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯");
  }

  onSnapshot(ref, snap => {
    log("ğŸ“¡ Firestore å¤‰æ›´æ¤œçŸ¥");

    if (snap.exists() && snap.data().ring === true) {
      log("ğŸ”” ring = true ã‚’æ¤œçŸ¥");

      audio.currentTime = 0;
      audio.play()
        .then(() => log("ğŸ”Š å†ç”Ÿé–‹å§‹"))
        .catch(() => log("âŒ å†ç”Ÿå¤±æ•—"));

      updateDoc(ref, { ring: false });
    }
  });
};

// å‘¼ã¶å´
btnCall.onclick = async () => {
  log("â–¶ å‘¼ã¶ãƒœã‚¿ãƒ³æŠ¼ä¸‹");
  await setDoc(ref, {
    ring: true,
    updatedAt: serverTimestamp()
  });
  log("âœ” Firestore ã«æ›¸ãè¾¼ã¿å®Œäº†");
};
</script>

</body>
</html>
