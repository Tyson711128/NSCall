<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NSCall</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: system-ui, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  button {
    font-size: 10vw;
    padding: 60px 100px;
    border-radius: 30px;
    border: none;
    background: #d32f2f;
    color: #fff;
    cursor: pointer;
  }

  #status {
    margin-top: 30px;
    font-size: 4vw;
    opacity: 0.8;
  }

  .ok { color: #00e676; }
  .ng { color: #ff5252; }
</style>
</head>
<body>

<button id="callBtn">CALL</button>
<div id="status" class="ng">未接続</div>

<audio id="sound" src="audio.mp3" preload="auto"></audio>

<script type="module">
/* ===== Firebase SDK ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== Firebase 設定 ===== */
const firebaseConfig = {
  apiKey: "AIzaSyA-0pjEemq37VlZHd22Wh6iCELwanieQMg",
  authDomain: "nscall-35754.firebaseapp.com",
  projectId: "nscall-35754"
};

/* ===== 初期化 ===== */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ref = doc(db, "calls", "main");

/* ===== DOM ===== */
const btn = document.getElementById("callBtn");
const status = document.getElementById("status");
const sound = document.getElementById("sound");

/* ===== 音声をユーザー操作で解放 ===== */
btn.onclick = async () => {
  // 自分の端末を即鳴動
  sound.currentTime = 0;
  sound.play();

  // Firestore に通知（他端末用）
  await setDoc(ref, {
    ring: Date.now(),
    updatedAt: serverTimestamp()
  });
};

/* ===== Firestore 監視 ===== */
onSnapshot(
  ref,
  snap => {
    status.textContent = "接続中";
    status.className = "ok";

    if (!snap.exists()) return;

    const data = snap.data();
    if (!data.ring) return;

    // 他端末からの通知を鳴動
    sound.currentTime = 0;
    sound.play();
  },
  err => {
    status.textContent = "未接続";
    status.className = "ng";
  }
);
</script>

</body>
</html>
